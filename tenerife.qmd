---
title: "Anàlisi Exploratòria Lleres Tenerife"
author: "Miquel Àngel Aguiló, Joan Camps, Gerard Ribas"
format: html
lang: ca
---

```{css, echo=FALSE}
/* Estil de sortida per HTML/CSS */
/* Per posar notes pròpies */
todo {color: magenta}
gra {color: rgb(237, 65, 65)}
jct {color: #6666ff}
maa {color: #66bb66}
note {color: orange}
comment {display: none}
gra::before {
   content: "[G: ";
   font-weight: bold;
}
jct::before {
   content: "[J: ";
   font-weight: bold;
}
maa::before {
   content: "[M: ";
   font-weight: bold;
}
note::before {
   content: "[NOTA: ";
   font-weight: bold;
}
todo::before {
   content: "[TODO: ";
   font-weight: bold;
}
gra::after, jct::after, note::after, todo::after, maa:after {
   content: "]";
}
```

```{r, echo=FALSE, include=FALSE}
library(tidyverse)
library(ggplot2)
```


# Introducció i objectiu

blablabla. Idea: comprovar si les longituds 2d i 3d segueixen la mateixa distribució

<gra>Comentari Gerard</gra>

<jct>Comentari Joan</jct>

<maa>Comentari Miki</maa>

<todo>un TODO</todo>

# Anàlisi exploratòria

## Càrrega de dades

Carreguem el CSV a R, i comecem comentant les dades que hi apareixen.

```{r}
rius = read.csv("inventario-insular-de-cauces-de-tenerife.csv")
str(rius)
```

Es pot consultar [aquesta web](https://datos.tenerife.es/es/datos/tablero?resourceId=f630dd85-9e4f-45f6-8bd4-212924a8a0b0) per entendre les variables.

Les dades tracten sobre lleres de l'illa de Tenerife. Les variables que es contemplen són les que segueixen:

-   **cauce_id**: de tipus qualitatiu, nombre que identifica unívocament cada una de les lleres registrades a l'illa.

-   **cauce_toponimos**: de tipus qualitatiu, es refereix al nom donat a la llera.

-   **cacue_alonimos**: de tipus qualitatiu, es refereix a una possible variant del nom expressat a la variable anterior per referir-se a la mateixa llera.

-   **cauce_nivel**: de tipus ordinal, s'utilitza per identificar i ordenar les diferents bifurcacions d'una mateixa llera segons el grau d'importància. El nivell 1 indica una llera principal, i nivells superiors són afluents dels nivells anteriors.

-   **cauce_orden**: de tipus ordinal, s'utilitza per ordenar les afluents d'una llera respecte del nivells anteriors. Un nombre '1xy' de nivell 3 indica que és l'afluent y de l'afluent x de la llera principal. En l'[Inventario oficial de cauces de la Demarcación Hidrpgráfica de Tenerife](https://www.aguastenerife.org/images/pdf/PHT1erCiclo/III-DocumentoGestionGobernanza/III-1-Normativa/III-1-2-Anejos/III-1-2-Anejo4-InventarioCauces.pdf) es pot consultar la jerarquia de totes les lleres.

Per exemple, si una llera té nivell 1 vol dir que és un dels rius principals de la conca; si d'un d'aquests torrents de nivell 1 llavors 11, 12, ..., 19, 1A són les bifurcacions d'aquella llera. Aquestes poden tenir altres bifurcacions, per exemple 111, 112, ... I així inductivament. Notem que la primera xifra sempre sirà 1 perquè comença a un torrent principal sempre. També cal explicar que podem tenir diversos afluents amb el mateix ordre, ja que el que els diferencia és l'id del corrent d'aigua principal (**cauce_principal_id**)

- **cauce_longitud_2d**: de tipus quantitatiu continu, és la mesura de la longitud de la llera en metres si fos mesurat sobre un mapa.

- **cauce_longitud_3d**: de tipus quantitatiu continu, és la mesura de la longitud real del riu tenint en compte l'altitud (mesurat sobre un model digital del terreny).

- **cuenca_principal_id**: de tipus qualitatiu, és un identificador de les conques de l'illa. Totes les lleres que desenboquen en una mateixa conca formen una xarxa.

- **cauce_nombre_phi**: de tipus qualitatiu, és el nom de llera que consta en el PHI (Plan Hidrológico Insular)

- **cauce_rotulo_phi**: de tipus qualitatiu, és el ròtul o nom que s'empra a la pràctica per etiquetar cada llera en el PHI.

## Longituds en 2D i en 3D globals

<todo> afegir llegenda, arreglar títols gràfiques, ... </todo>

Mostrem la distribució de les longituds en metres en 2D i en 3D superposades en un mateix gràfic.

```{r}
plot(density(rius$cauce_longitud_2d), col = "blue")
lines(density(rius$cauce_longitud_3d), col = "red")
```

Com que hi ha molt pocs rius que arribin al quilòmetre de llargària, visualitzarem millor la densitat si ens restringim a aquestes lleres.

```{r}
sprintf("Rius de menys d'1km (en 2d): %d", sum(rius$cauce_longitud_2d < 1000))
plot(density(rius$cauce_longitud_2d), col = "blue", xlim = c(0, 1000))
lines(density(rius$cauce_longitud_3d), col = "red")
```

Podem fer-nos una idea de si la diferència entre les longituds 2d i 3d registrades és consistent. A partir de les conques principals, considerem l'acumulat de les longituds 2d i 3d de les lleres que hi desenboquen, i visualitzem l'error relatiu (això és $ \frac{long\_3d - long\_2d}{long\_3d}$) entre dits valors. Entendrem per conques principals aquelles en què hi ha un major nombre de lleres que hi finalitzen.

```{r}
#Agrupam per nombre de conca, i acumulam valors de longituds
df_2 <- rius %>%
    group_by(cuenca_principal_id) %>%
    summarise(cauce_longitud_2d=sum(cauce_longitud_2d), cauce_longitud_3d=sum(cauce_longitud_3d), count = n())
#Ens quedam amb les 5 conques amb més lleres
df_2 = df_2[order(df_2$count,decreasing=TRUE, na.last=FALSE),]
df_2=df_2[1:5,]

#Diagrama de barres de la diferència relativa al total de longitud 3d. i.e (3d-2d)/3d
df_2$dif_relativa = ((df_2$cauce_longitud_3d - df_2$cauce_longitud_2d) / df_2$cauce_longitud_3d)

barplot(df_2$dif_relativa, beside = TRUE, names.arg = df_2$cuenca_principal_id,
        xlab = 'id Conca', ylab = 'Error relatiu',ylim = c(0,1),
        main = 'Diferència relativa de longituds acumulades')

```
Per apreciar-ho millor, restringim l'eix d'ordenades al valor màxim del gràfic.
```{r}
barplot(df_2$dif_relativa, beside = TRUE, names.arg = df_2$cuenca_principal_id,
        xlab = 'id Conca', ylab = 'Error relatiu',ylim = c(0,max(df_2$dif_relativa)+0.01),
        main = 'Diferència relativa de longituds acumulades')
```


<jct>Havia fet tb aquest gràfic, però amb so ser valors tan diferents entre conques quasi no s'aprecien bé ses diferències. Ho podem llevar, no?</jct>
```{r}
# Create a matrix of the two columns to plot
values <- as.matrix(df_2[, c('cauce_longitud_2d', 'cauce_longitud_3d')])

# Create the barplot
barplot(t(values), beside = TRUE, names.arg = df_2$cuenca_principal_id, col = c('blue', 'red'),
        legend = c('Long 2d', 'Long 3d'), xlab = 'id Conca', ylab = 'Acumulat', 
        main = 'Longituds acumulades per conques')

```


Per seguir comparant el dos tipus de longituts, el que farem serà agafarles 5 lleres amb més afluents, i veure la relació d'aquestes dues longituts.

```{r}
freqüències=table(rius$cuenca_principal_id)
freqüències_ordenades=sort(freqüències,decreasing = TRUE)
top_5_rius=head(freqüències_ordenades,5)
top_5_rius #Aquests són els idprincipals dels rius amb més afluents.
suma_long2d = 0
```